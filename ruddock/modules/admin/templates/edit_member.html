{% extends "layout.html" %}

{% block head %}
<script src="//ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
{# CSS and JS for overlays #}
<script src="{{ url_for('static', filename='js/overlay.js') }}"></script>
<link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='css/overlay.css') }}" />

<script>
/* Makes the select menu blank initially, without providing a blank option. */
$(document).ready(function() {
    $("#office_select").prop("selectedIndex", -1);
});

/* Provides an interface for selecting a member. */
function showSelectMemberUI() {
  showOverlay();

  var ui = document.createElement("div");
  $(ui).text("Select someone from the list below.");
  $(ui).append("<br><br>");
  var searchInput = document.createElement("input");
  searchInput.type = "text";
  searchInput.id = "memberSearchInput";
  searchInput.placeholder = "Search for a person...";
  $(searchInput).css({
      "width": "90%",
  });
  $(ui).append(searchInput);
  $(ui).append("<br><br>");

  var results = document.createElement("table");
  results.id = "memberSearchResults";
  $(ui).append(results);

  // Load the initial contents of the table.
  $.ajax({
    url: "{{ url_for('admin.ajax_get_members') }}",
    method: "GET",
    dataType: "json",
    success: function(response) {
      for (var i = 0; i < response.length; i++) {
        var member = response[i];
        var row = document.createElement("tr");
        $(row).prop("data-user-id", member.user_id);
        $(row).prop("data-name", member.name);
        var cell = document.createElement("td");
        $(cell).text(member.name);

        // Handle selecting the user.
        $(row).click(selectMember);

        $(row).append(cell);
        $(results).append(row);
      }
    },
  });

  // Set event handler for search input.
  $(searchInput).on("input", filterMembers);

  $(ui).css({
    "padding": "20px",
  });
  $("#overlayWindow").css({
    "height": "60%",
    "overflow": "auto",
  });
  $("#overlayWindow").append(ui);
  centerOverlay();
}

/* Filters the list of members using the search query. */
function filterMembers() {
  var query = $("#memberSearchInput").val();

  // If the query is cleared, everything should be shown.
  if (query.length === 0) {
    $("#memberSearchResults tr").show();
    return;
  }

  // Perform the search using an AJAX request.
  $.ajax({
    url: "{{ url_for('admin.ajax_search_members') }}",
    method: "GET",
    data: {
      query: query,
    },
    dataType: "json",
    success: function(response) {
      $("#memberSearchResults tr").each(function() {
        var user_id = $(this).prop("data-user-id");
        if ($.inArray(user_id, response) > -1) {
          $(this).show();
        } else {
          $(this).hide();
        }
      });
    },
  });
}

/* Executes the logic when a member is actually selected. */
function selectMember() {
  var user_id = $(this).prop("data-user-id");
  var name = $(this).prop("data-name");
  $("#selectedUser").val(user_id);
  $("#selectedName").text(name);
  closeOverlay();
}
</script>
{% endblock head %}

{% block body %}
<h2>Edit existing members</h2>
Use this form to change the information of a member. All fields are required.<br><br>
<form action="{{ url_for('admin.edit_member_submit', user_id=member['user_id']) }}" method="POST">
  <table class="form">
    <tr>
      <td>First Name</td>
      <td><input type="text" name="fname" autofocus value="{{ member['first_name'] }}"
        placeholder="first name" /></td>
      <td>Last Name</td>
      <td><input type="text" name="lname" value="{{ member['last_name'] }}"
        placeholder="last name" /></td>
    </tr>
    <tr>
      <td>Matriculation Year</td>
      <td><input type="text" name="matriculate_year" value="{{ member['matriculation_year'] }}"
        placeholder="YYYY" /></td>
      <td>Graduation Year</td>
      <td><input type="text" name="grad_year" value="{{ member['graduation_year'] }}"
        placeholder="YYYY" /></td>
    </tr>
    <tr>
      <td>UID</td>
      <td><input type="text" name="uid" value="{{ member['uid'] }}"
        placeholder="0000000" /></td>
      <td>Email</td>
      <td><input type="text" name="email" value="{{ member['email'] }}"
        placeholder="test@example.com" /></td>
    </tr>
    <tr>
      <td>Membership Type</td>
      <td><select name="membership_desc">
        <option value="full">Full</option>
        <option value="social">Social</option>
        <option value="associate">Associate</option>
        <option value="ra">RA</option>
      </td>
    </tr>
  </table>
  <button type="button" onclick="location.href='{{ url_for('admin.add_members') }}'">
    Back
  </button>
  <button type="submit">Submit</button>
</form>
<br>
<br>
{% endblock body %}
